import { useState } from 'react'
import { computeDiscountedLine, findActiveCoupon } from '../lib/discounts'
export default function CartDrawer({open,onClose,cart,onInc,onDec,onSubmit,basePercent,coupons=[]}){const[code,setCode]=useState('');const active=findActiveCoupon(coupons,code);const couponPercent=active?.percent||0;const lines=cart.map(it=>({...it,pricing:computeDiscountedLine(it.price,it.qty,{basePercent,couponPercent})}));const totals=lines.reduce((a,l)=>{a.subtotal+=l.pricing.subtotal;a.discount+=l.pricing.discount;a.total+=l.pricing.total;return a;},{subtotal:0,discount:0,total:0});if(!open)return null;return(<div className='fixed inset-0 z-50'><div className='absolute inset-0 bg-black/30' onClick={onClose}></div><div className='absolute top-0 right-0 h-full w-full sm:w-[420px] bg-white shadow-xl p-4 overflow-y-auto'><h3 className='font-bold text-lg mb-3'>سبد خرید</h3>{cart.length===0&&<p className='text-sm text-gray-500'>سبد خالی است.</p>}<ul className='space-y-2'>{cart.map(it=>(<li key={it.id} className='flex items-center justify-between border rounded-xl p-2'><div><p className='font-bold text-sm'>{it.name}</p><p className='text-xs text-gray-500'>{it.price.toLocaleString('fa-IR')} تومان</p></div><div className='flex items-center gap-2'><button onClick={()=>onDec(it.id)} className='w-8 h-8 border rounded'>-</button><span>{it.qty}</span><button onClick={()=>onInc(it.id)} className='w-8 h-8 border rounded'>+</button></div></li>))}</ul><div className='mt-4 space-y-2'><label className='block text-sm'>کد تخفیف<input value={code} onChange={e=>setCode(e.target.value)} className='mt-1 w-full border rounded-xl p-2' placeholder='مثلاً: WELCOME10'/></label>{active&&<p className='text-xs text-green-600'>کوپن فعال: {active.code} – {active.percent}%</p>}</div><div className='mt-4 border-t pt-3 space-y-1 text-sm'><div className='flex justify-between'><span>جمع جزء</span><span>{totals.subtotal.toLocaleString('fa-IR')} تومان</span></div><div className='flex justify-between text-green-700'><span>تخفیف</span><span>-{totals.discount.toLocaleString('fa-IR')} تومان</span></div><div className='flex justify بین'><span>مبلغ قابل پرداخت</span><span>{totals.total.toLocaleString('fa-IR')} تومان</span></div></div><button disabled={!cart.length} onClick={()=>onSubmit({couponCode:active?.code,couponPercent,totals})} className='mt-4 w-full rounded-xl bg-purple-600 text-white py-3 disabled:opacity-40'>ثبت سفارش</button></div></div>)}